<!DOCTYPE html>
<html>
<head>
  <title>‚ö° Pok√©dex Entrenadores ConceGo ‚ö°</title>
  <meta charset="UTF-8">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    /* estilos iguales a los anteriores, omitidos por brevedad */
    body {
      font-family: 'Press Start 2P', cursive;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(180deg,#ff0000 0%,#ffffff 50%,#000000 100%);
      color:#333;
    }
    /* ... (dejo los mismos estilos que ya ten√≠as con tabla-wrapper, botones, etc.) */
  </style>
</head>
<body>
<div class="container">
  <h1>üéÆ Pok√©dex de Entrenadores ConceGo üéÆ</h1>

  <!-- LOGIN -->
  <div id="loginSection">
    <h2>üîê Ingresa tu nombre de Entrenador/a</h2>
    <div class="form-group" style="text-align:center;">
      <input id="userName" type="text" placeholder="Ej: Ash Ketchum" style="width:300px;">
      <button id="loginBtn">‚ö° Ingresar</button>
    </div>

    <h3>üîç Buscar entrenador@s</h3>
    <div class="form-group" style="text-align:center;">
      <input id="publicSearchInput" type="text" placeholder="Busca por nick o c√≥digo..." style="width:300px;">
      <button id="clearSearchBtn">üîÑ Limpiar</button>
    </div>
    <p><strong>Mostrando:</strong> <span id="publicShowing">0</span> de <span id="publicTotal">0</span></p>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr><th>Nick</th><th>C√≥digo</th><th>Contacto</th><th>Regalos</th></tr>
        </thead>
        <tbody id="publicUsersTable"><tr><td colspan="4">Cargando...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- MAIN -->
  <div id="mainSection" class="hidden">
    <h2>üëã Hola, <span id="currentUser"></span></h2>
    <button id="logoutBtn">üö™ Cerrar Sesi√≥n</button>

    <div class="highlight-card">
      <h3>‚ûï Agregar Nuevo Entrenador</h3>
      <input id="nickInput" type="text" placeholder="Nick">
      <input id="codeInput" type="text" placeholder="C√≥digo">
      <input id="contactInput" type="text" placeholder="Contacto (opcional)">
      <label><input type="checkbox" id="giftsCheckbox"> üéÅ Env√≠a regalos</label>
      <button id="addUserBtn">‚úÖ Agregar</button>
      <div id="message"></div>
    </div>

    <h3>üìã Gesti√≥n</h3>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr><th>Nick</th><th>C√≥digo</th><th>Contacto</th><th>Regalos</th><th>CreadoPor</th><th>Acciones</th></tr>
        </thead>
        <tbody id="usersTable"><tr><td colspan="6">Cargando...</td></tr></tbody>
      </table>
    </div>
    <p>Total: <span id="totalUsers">0</span></p>
  </div>

  <!-- Export -->
  <h3>üì§ Exportar</h3>
  <button id="exportBtn">üíæ Exportar TXT</button>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxRJ0S1WWLzeCeefoZYh8eeqt6d6ZWavClhQ3mzm31Yd78hqXLLp6vweIv59JogZWiSHg/exec'; // pega aqu√≠ la URL desplegada de Apps Script
let currentUser = "";
let users = [];
let allPublicUsers = [];

function escapeHtml(str){return (str??"").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}

document.getElementById("loginBtn").onclick = login;
document.getElementById("logoutBtn").onclick = logout;
document.getElementById("addUserBtn").onclick = addUser;
document.getElementById("clearSearchBtn").onclick = ()=>renderPublicUsersTable(allPublicUsers);
document.getElementById("exportBtn").onclick = exportToTXT;

function login(){
  const name = document.getElementById("userName").value.trim();
  if(!name) return alert("Ingresa tu nombre");
  currentUser = name;
  document.getElementById("currentUser").textContent = name;
  document.getElementById("loginSection").classList.add("hidden");
  document.getElementById("mainSection").classList.remove("hidden");
  loadUsers();
}
function logout(){
  currentUser="";
  document.getElementById("loginSection").classList.remove("hidden");
  document.getElementById("mainSection").classList.add("hidden");
}

async function loadUsers(){
  const res = await fetch(SCRIPT_URL+"?action=getUsers");
  const data = await res.json();
  if(data.success){ users = data.users; renderUsersTable(); }
}
async function addUser(){
  const nick = document.getElementById("nickInput").value.trim();
  const code = document.getElementById("codeInput").value.trim();
  const contact = document.getElementById("contactInput").value.trim();
  const gifts = document.getElementById("giftsCheckbox").checked ? "‚úÖ" : "";
  if(!nick||!code) return alert("Nick y c√≥digo requeridos");

  const url = `${SCRIPT_URL}?action=addUser&nick=${encodeURIComponent(nick)}&code=${encodeURIComponent(code)}&contact=${encodeURIComponent(contact)}&gifts=${encodeURIComponent(gifts)}&creator=${encodeURIComponent(currentUser)}`;
  const res = await fetch(url);
  const data = await res.json();
  if(data.success){ alert("Agregado!"); loadUsers(); loadPublicUsers(); }
}
async function deleteUser(nick){
  if(!confirm("¬øEliminar "+nick+"?")) return;
  const url = `${SCRIPT_URL}?action=deleteUser&nick=${encodeURIComponent(nick)}&creator=${encodeURIComponent(currentUser)}`;
  const res = await fetch(url);
  const data = await res.json();
  if(data.success){ loadUsers(); loadPublicUsers(); }
}

function renderUsersTable(){
  const tbody=document.getElementById("usersTable"); tbody.innerHTML="";
  if(!users.length){tbody.innerHTML="<tr><td colspan=6>Sin registros</td></tr>";return;}
  users.forEach(u=>{
    const btn = u.CreadoPor===currentUser ? `<button onclick="deleteUser('${escapeHtml(u.Nick)}')">üóëÔ∏è</button>` : "üîí";
    tbody.innerHTML += `<tr><td>${escapeHtml(u.Nick)}</td><td>${escapeHtml(u.Codigo)}</td><td>${escapeHtml(u.Contacto||"-")}</td><td>${escapeHtml(u.Regalos||"-")}</td><td>${escapeHtml(u.CreadoPor||"-")}</td><td>${btn}</td></tr>`;
  });
  document.getElementById("totalUsers").textContent=users.length;
}

async function loadPublicUsers(){
  const res=await fetch(SCRIPT_URL+"?action=getUsers&ts="+Date.now());
  const data=await res.json();
  if(data.success){allPublicUsers=data.users;renderPublicUsersTable(allPublicUsers);}
}
function renderPublicUsersTable(arr){
  const tbody=document.getElementById("publicUsersTable"); tbody.innerHTML="";
  document.getElementById("publicTotal").textContent=allPublicUsers.length;
  document.getElementById("publicShowing").textContent=arr.length;
  if(!arr.length){tbody.innerHTML="<tr><td colspan=4>Sin resultados</td></tr>";return;}
  arr.forEach(u=>{
    tbody.innerHTML+=`<tr><td>${escapeHtml(u.Nick)}</td><td>${escapeHtml(u.Codigo)}</td><td>${escapeHtml(u.Contacto||"-")}</td><td>${u.Regalos||"-"}</td></tr>`;
  });
}
function exportToTXT(){
  if(!allPublicUsers.length){alert("No hay datos");return;}
  let txt="LISTA ENTRENADORES\n\n";
  allPublicUsers.forEach(u=>{
    txt+=`Nick: ${u.Nick}\nCodigo: ${u.Codigo}\nContacto: ${u.Contacto||"-"}\nRegalos: ${u.Regalos||"-"}\n---\n`;
  });
  const blob=new Blob([txt],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="Entrenadores.txt";
  a.click();
}
window.onload=()=>{loadPublicUsers();};
</script>
</body>
</html>
